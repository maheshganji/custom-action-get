name: Manual Deploy to Production

on:
  workflow_dispatch:

jobs:
  deploy-prod:
    name: Deploy to Production & ServiceNow Change demo
    runs-on: ubuntu-latest

    env:
      SERVICENOW_INSTANCE: ${{ secrets.SN_INSTANCE_URL }}
      SERVICENOW_TOKEN: ${{ secrets.SN_DEVOPS_INTEGRATION_TOKEN }}
      TOOL_ID: ${{ secrets.SN_ORCHESTRATION_TOOL_ID }}

    steps:
      # Checkout code from selected branch
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable debug logging
        run: |
          echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV
          echo "ACTIONS_RUNNER_DEBUG=true" >> $GITHUB_ENV
      # Create ServiceNow Change Request using token + tool ID
      - name: Create ServiceNow Change Request
        id: create-change
        uses: ServiceNow/servicenow-devops-change@v6.1.0
        with:
          instance-url: ${{ env.SERVICENOW_INSTANCE }}
          devops-integration-token: ${{ env.SERVICENOW_TOKEN }}
          tool-id: ${{ env.TOOL_ID }}
          context-github: ${{ toJSON(github) }}
          job-name: 'ServiceNow DevOps Change'
          change-request: >
            {
            "attributes": {
              "requested_by": "b59f9d2c334316d042d4acf57d5c7b31",
              "assignment_group": "2bea999287c04210a1fe670a0cbb353f",
              "cmdb_ci":"0d31a33f1bce555088f11023b24bcb3f",
              "business_service": "0d31a33f1bce555088f11023b24bcb3f",
              "u_it_security_risk_or_vulnerability": "no",
              "short_description": "GitHub change",
              "risk": "low",
              "impact": "low",
              "description": "GitHub change",
              "justification": "Test",
              "implementation_plan": "Test",
              "backout_plan": "Test",
              "test_plan": "Test",
              "risk_impact_analysis": "Test",
              "start_date": "2025-11-11 08:15:43",
              "end_date":"2024-11-11 15:16:06"
              },
              "setCloseCode": "true",
              "autoCloseChange": false
            }
          interval: '100'
          timeout: '3600'
          changeCreationTimeOut: '3600'
          abortOnChangeCreationFailure: true
          abortOnChangeStepTimeout: true

      - name: Validate ServiceNow Change Number
        id: validate-change
        if: failure() || success()
        run: |
          echo "Step outputs:"
          echo '${{ toJSON(steps.create-change.outputs) }}'
          echo "Checking if ServiceNow change number was returned..."
          if [ -z "${{ steps.create-change.outputs['change-request-number'] }}" ]; then
            echo "❌ No change number received from ServiceNow. Aborting workflow."
            exit 1
          else
            echo "✅ Change number received: ${{ steps.create-change.outputs['change-request-number'] }}"
          fi
      # Simulate deployment (replace with your real commands)
      - name: Deploy to Production
        run: |
          echo "Deploying application ${{ env.APPLICATION_NAME }} to ${{ github.event.inputs.environment }}..."
          # Replace with your real deployment commands
          sleep 2
          echo "Deployment complete!"
      # Update ServiceNow Change Request to "Implemented" after success
      - name: Update ServiceNow Change to Implemented
        if: success() && steps.create-change.outputs['change-request-number'] != ''
        uses: ServiceNow/servicenow-devops-update-change@v5.1.0
        with:
          devops-integration-token: ${{ env.SN_DEVOPS_TOKEN }}
          instance-url: ${{ env.SN_INSTANCE_URL }}
          tool-id: ${{ env.SN_TOOL_ID }}
          change-request-number: ${{ steps.create-change.outputs['change-request-number'] }}
          context-github: ${{ toJSON(github) }}
          job-name: Deploy
          change-request: >
            {
              "attributes": {
                "state": "Implemented",
                "work_notes": "Deployment completed successfully via GitHub Actions."
              }
            }
      # Handle Deployment Failures — mark change as failed
      - name: Mark Change as Failed
        if: failure() && steps.create-change.outputs['change-request-number'] != ''
        uses: ServiceNow/servicenow-devops-update-change@v5.1.0
        with:
          devops-integration-token: ${{ env.SN_DEVOPS_TOKEN }}
          instance-url: ${{ env.SN_INSTANCE_URL }}
          tool-id: ${{ env.SN_TOOL_ID }}
          change-request-number: ${{ steps.create-change.outputs['change-request-number'] }}
          context-github: ${{ toJSON(github) }}
          job-name: Deploy
          change-request: >
            {
              "attributes": {
                "state": "Review",
                "work_notes": "Deployment failed. Please review logs and take corrective actions."
              }
            }
